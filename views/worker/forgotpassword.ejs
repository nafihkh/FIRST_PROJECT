<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>
        <%= title %> | MyApp
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/css/login.css">
    <style>
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: #f1f5f9;
            display: block;
            width: 150px;
        }

        .logo-img {
            display: block;
            width: 100%;
        }
    </style>

</head>


<body>
    <%- include('../partials/tosta') %>
    <div id="particles-js"></div>
    <div class="logo">
        <img src="/images/logo.png" alt="" class="logo-img">
    </div>
    <p class="text-center login-p">
        Welcome back! Please sign in to your account
    </p>
    <div class="mx-auto login-box">
        <h2 class="login-text mb-3">Reset Password</h2>
        <p class="text-center login-p">
            A password reset OTP will be sent to your email address.
        </p>
        <form id="resetForm">
            <input id="email" name="email" type="email" class="input-box mb-3" placeholder="Email Address" required />
            <button type="submit" id="submitBtn" class="btn btn-primary login-btn">
                <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                <span class="btn-text">Send Verification Code</span>
            </button>
        </form>


        <p class="label">Remember your password? <a href="/worker/login">Login</a></p>
        <p id="error-msg" class="text-danger"></p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
        particlesJS("particles-js", {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#3b82f6" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: true },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#3b82f6",
                    opacity: 0.2,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: "none",
                    random: true,
                    straight: false,
                    out_mode: "out",
                    bounce: false
                }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "repulse" },
                    onclick: { enable: true, mode: "push" },
                    resize: true
                }
            }
        });
        const form = document.getElementById("resetForm");
        const btn = document.getElementById("submitBtn");
        const spinner = btn.querySelector(".spinner-border");
        const btnText = btn.querySelector(".btn-text");

        function setLoading(state) {
            btn.disabled = state;              // prevent double submits
            btn.setAttribute("aria-busy", state ? "true" : "false"); // a11y busy state
            spinner.classList.toggle("d-none", !state); // show/hide spinner
            btnText.textContent = state ? "Sending..." : "Send Verification Code"; // label
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            setLoading(true);
            const email = document.getElementById("email").value;

            try {
                const res = await fetch("/auth/worker/forgot-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email }),
                });

                const data = await res.json();

                if (res.ok) {
                    showToast('success', 'Sending Otp...', `${data.message}`)
                    // keep loading until navigation
                    setTimeout(() => {
                        window.location.href = "/worker/verify-otp?email=" + encodeURIComponent(email);
                    }, 1500);
                } else {
                    showToast('error', 'Something went wrong', `${data.error}`)
                    setLoading(false);
                }
            } catch (err) {
                showToast('error', 'Server error', 'There was an Server error. Please try again later.')
                setLoading(false);
            }
        });
    </script>
</body>

</html>