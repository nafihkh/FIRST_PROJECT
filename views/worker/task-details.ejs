<!DOCTYPE html>
<html lang="en">

<head>
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @font-face {
            font-family: "Inter";
            src: url("/fonts/Inter-Regular.ttf");
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --primary-darker: #1e3a8a;
            --secondary: #0ea5e9;
            --accent: #06b6d4;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-card-hover: #334155;
            --text-light: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-dark: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
        }

        body {
            font-family: "Inter";
            background-color: var(--dark-bg);
            color: var(--text-light);
        }

        .cart-img {
            width: 358px;
            height: 196px;
            object-fit: cover;
        }

        .progress-container {
            background: var(--dark-card);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }

        .step .circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: var(--primary);
            color: var(--text-light);
            z-index: 1;
            transition: all 0.3s ease;
        }

        .step.inactive .circle {
            background: var(--text-muted);
        }

        .step::after {
            content: "";
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 3px;
            background: var(--text-muted);
            z-index: 0;
            transition: all 0.3s ease;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active~.step::after {
            background: var(--text-muted);
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .step-label {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .btn-primary {
            background: var(--gradient);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--gradient-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background-color: var(--text-muted);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: var(--text-muted);
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--error);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        .modal-content {
            background-color: var(--dark-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-control {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
        }
        .form-control::placeholder {
        
            color: var(--text-light);
        }


        /* Animation for progress steps */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .step .circle {
            animation: fadeInScale 0.5s ease forwards;
        }

        .step:nth-child(1) .circle { animation-delay: 0.1s; }
        .step:nth-child(2) .circle { animation-delay: 0.2s; }
        .step:nth-child(3) .circle { animation-delay: 0.3s; }
        .step:nth-child(4) .circle { animation-delay: 0.4s; }
        .step:nth-child(5) .circle { animation-delay: 0.5s; }
    </style>
</head>

<body>

    <%- include('../partials/header') %>

        <div class="d-flex">

            <%- include('../partials/sidebar') %>
            <%- include('../partials/tosta') %>

                <div class="flex-grow-1 p-4">
                    <h6 class="mb-4"><a class="text-decoration-none" style="color: var(--text-muted);"
                            href="/worker/activejobs"><i class="bi bi-arrow-left" style="color: var(--text-muted);"></i> Back to
                            List</a></h6>
                    <div class="row g-4 rounded-3 m-0 p-0"
                        style="background: var(--dark-card); border: 1px solid rgba(255, 255, 255, 0.05);">

                        <div class="col-md-10">
                            <div class="d-flex mb-3">
                                <h6 class="mb-0 pb-0 me-3" style="color: var(--text-light); font-size: 20px;">
                                    <%= task.title %>
                                </h6>
                                <label for="" style="font-size: 14px; height: 30px;"
                                    class="btn btn-primary rounded-4 btn-sm fw-medium">
                                    <%= task.progress %>
                                </label>
                            </div>
                            <p class="mt-0 pt-0 mb-2" style="color: var(--text-light); font-size: 16px;">
                                <%= task.description %>
                            </p>
                            <div class="row align-items-center mb-2 mt-3">

                                <div class="col-md-4">
                                    <h5 class="fw-semibold my-auto mb-2" style="font-size: 14px; color:var(--text-muted);">Budget
                                    </h5>
                                    <label class="mt-0 pt-0 mb-1 fw-semibold" style="color: var(--success); font-size: 14px;">$
                                        <%= task.amount %>
                                    </label>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="fw-semibold my-auto mb-1" style="font-size: 14px; color:var(--text-muted);">Dead
                                        line</h5>
                                    <label class="mt-0 pt-0 mb-1 fw-semibold" style="color: var(--text-light); font-size: 14px;">
                                        <%= new Date(task.deadline).toLocaleDateString('en-US', { month: 'short' ,
                                            day: 'numeric' , year: 'numeric' }) %>
                                    </label>
                                </div>

                                <div class="col-md-4">
                                    <a href="#" class="btn btn-danger text-white" style="height: 32px; font-size: 14px" data-bs-toggle="modal"
   data-bs-target="#reportModal" >Report</a>
                                    <% if (task.progress==="InProgress" ) { %>
                                        <form action="/worker/tasks/<%= task._id %>/progress?_method=PATCH"
                                            method="POST" style="display:inline;"
                                            onsubmit="return confirm('Are you sure you want to mark this task as complete?');">
                                            <button type="submit" class="btn fw-lighter"
                                                style="height: 32px; font-size: 14px; background:var(--success); color:var(--text-light);">
                                                Mark As Complete
                                            </button>
                                        </form>
                                        <% } %>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 ">
                            <div class="text-center mx-auto d-flex">
                                <img class="rounded-circle me-1"
                                    src="<%= task.user_id?.profile_photo || 'https://res.cloudinary.com/dqugwh4su/image/upload/v1761538454/profileeg_tnbpak.jpg' %>" alt=""
                                    width="30px" height="30px">
                                <h6 class="mt-2" style="font-size: 12px; color: var(--text-light);">
                                    <%= task.user_id.username %>
                                </h6>
                            </div>
                           <a href="/worker/create/<%= task.user_id._id %>/user/<%= task.title %>/<%= task._id %>"
                                class="btn btn-primary rounded-3 mt-4">
                                <i class="bi bi-receipt text-white me-1"></i> Chat
                            </a>

                        </div>
                    </div>
                    <div class="row g-4 mt-2">
                        <div class="col-md-8">
                            <div class="card p-3"
                                style="background: var(--dark-card); border: 1px solid rgba(255, 255, 255, 0.05);">
                                <h6 class="fw-bold mb-3" style="color: var(--text-light);">Project Progress</h6>
                                <div class="steps">
                                    <% 
                                        const stepOrder = ["Accepted", "Working", "Submitted", "Approved", "Paid"];
                                        let progressIndex = 0;
                                        switch(task.progress) {
                                        case "InProgress": progressIndex = 1; break;
                                        case "Submitted": progressIndex = 2; break;
                                        case "Approved": progressIndex = 3; break;
                                        case "Completed": progressIndex = 4; break;
                                        default: progressIndex = 0; // Not Taken / Accepted
                                        }
                                    %>

                                    <% stepOrder.forEach((step, index) => { %>
                                        <div class="step <%= index > progressIndex ? 'inactive' : '' %>">
                                        <div class="circle"><%= index + 1 %></div>
                                        <div class="step-label"><%= step %></div>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3"
                                style="background: var(--dark-card); border: 1px solid rgba(255, 255, 255, 0.05);">
                                <h6 class="fw-bold mb-2" style="color: var(--text-light);"> 
                                    <img class="p-2 rounded-circle me-2"
                                        src="https://res.cloudinary.com/dqugwh4su/image/upload/v1761538417/clock_zdpr3e.svg" alt=""
                                        style="height: 44px; width: 44px; background-color: #d38d00" />
                                    Deadline
                                </h6>

                               <h1 class="text-center fw-bold" style="color: var(--warning); font-size: 24px;" id="countdown"
                                    data-deadline="<%= task.deadline ? task.deadline.toISOString() : '' %>">
                                    Loading...
                                </h1>

                                <h5 class="text-center my-auto mb-1" style="font-size: 12px; color:var(--text-muted);">Time
                                    remaining</h5>

                            </div>
                        </div>
                    </div>
                    <!-- Report Modal -->
                    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                        <div class="modal-header" style="background: var(--gradient); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <h5 class="modal-title" style="color: var(--text-light);" id="reportModalLabel">Submit Task Report</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                             <form id="reportForm">
                            <div class="mb-3">
                                <label for="summary" class="form-label" style="color: var(--text-light);">Summary</label>
                                <textarea class="form-control text-white" id="summary" rows="4" name="summary" placeholder="Write your report..." required></textarea>
                            </div>


                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Submit Report</button>
                        </div>
                        </form>
                        
                        </div>
                    </div>
                    </div>
                    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
                        <div id="reportToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                            <div class="toast-body" id="toastMessage">Report submitted successfully!</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>

                    <script>
                        const countdownEl = document.getElementById('countdown');
                        const deadlineStr = countdownEl.dataset.deadline;

                        if (deadlineStr) {
                            const deadline = new Date(deadlineStr);

                            function updateCountdown() {
                                const now = new Date();
                                const diff = deadline - now;

                                if (diff <= 0) {
                                    countdownEl.innerText = "Deadline Passed";
                                    clearInterval(timer);
                                    return;
                                }

                                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                                countdownEl.innerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                            }

                            const timer = setInterval(updateCountdown, 1000);
                            updateCountdown(); // initial call
                        } else {
                            countdownEl.innerText = "No deadline set";
                        }
                        document.getElementById("reportForm").addEventListener("submit", async (e) => {
                            e.preventDefault(); // Prevent default form submission

                            const summary = document.getElementById("summary").value.trim();
                            if (!summary) {
                                alert("Please enter a report summary.");
                                return;
                            }

                            const taskId = "<%= task._id %>"; // Pass task ID from EJS

                            try {
                                const response = await fetch(`/worker/task/${taskId}/report`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ summary }),
                                });

                                const result = await response.json();

                                if (result.success) {

                                 showToast('success', 'Report submitted successfully!', `Please waite for Admin review`)
                                // Optionally clear textarea
                                document.getElementById("summary").value = "";
                                // Close modal after short delay
                                const modalEl = document.getElementById("reportModal");
                                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                                setTimeout(() => modalInstance.hide(), 1500);
                                } else {
                                showToast('warning', 'Failed to submit report!', `Please try again`)
                                }
                            } catch (error) {
                                showToast('error', 'Server error occurred!', `Please try again`)
                            }
                            });

                            // Function to show Bootstrap toast dynamically
                    </script>


                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>