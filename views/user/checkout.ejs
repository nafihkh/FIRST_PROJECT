<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Processing | JobSeek</title>
    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @font-face {
      font-family: "Inter";
      src: url("/fonts/Inter-Regular.ttf");
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #1e40af;
      --primary-darker: #1e3a8a;
      --secondary: #0ea5e9;
      --accent: #06b6d4;
      --dark-bg: #0f172a;
      --dark-card: #1e293b;
      --dark-card-hover: #334155;
      --text-light: #f1f5f9;
      --text-muted: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
      --gradient-dark: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
    }

    body {
      font-family: "Inter";
      background-color: var(--dark-bg);
      color: var(--text-light);
    }

    .topbar {
      width: 100%;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .topbar a {
      font-size: 14px;
      color: var(--text-muted);
      margin-right: 10px;
    }

    .active {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 3px;
    }

    .card {
      background: var(--dark-card);
      border: none;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }


    .btn-primary {
      background: var(--gradient);
      border: none;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: var(--gradient-dark);
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <%- include('../partials/header') %>

    <div class="d-flex">
      <%- include('../partials/sidebar') %>

        <div class="p-4">
          <h2 style="color: var(--text-light);">Processing Your Payment...</h2>
          <p style="color: var(--text-muted);">Invoice ID: <%= invoice._id %>
          </p>
          <p style="color: var(--text-muted);">Total Amount: ₹<%= invoice.total_amount %>
          </p>
        </div>
    </div>

   <script>
  window.onload = async function () {
    console.log("Pay button clicked!");

    const res = await fetch("/user/create-order/<%= invoice._id %>/pay");
    const data = await res.json();
    console.log("Received Order Data:", data);

    if (!data.success) {
      Swal.fire({
        icon: "error",
        title: "Order Error!",
        text: data.message,
        background: "#1e293b",
        color: "#f3f4f6",
        confirmButtonColor: "#3b82f6",
      });
      return;
    }

    const options = {
      key: data.key,
      amount: data.amount,
      currency: "INR",
      name: "Your Platform Name",
      description: "Invoice Payment",
      order_id: data.order_id,

      handler: async function (response) {
        // ✅ verification request
        const verifyRes = await fetch("/user/verify-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            invoiceId: "<%= invoice._id %>"
          }),
        });

        const result = await verifyRes.json();

        if (result.success) {
          Swal.fire({
            icon: "success",
            title: "Payment Successful!",
            text: "Your invoice has been paid successfully.",
            background: "#1e293b",
            color: "#f3f4f6",
            confirmButtonColor: "#10b981",
          }).then(() => {
            window.location.href = "/user/payments/invoice";
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Verification Failed!",
            text: "Payment could not be verified.",
            background: "#1e293b",
            color: "#f3f4f6",
            confirmButtonColor: "#ef4444",
          });
        }
      },
    };

    const rzp = new Razorpay(options);
    rzp.open();
  };
</script>

</body>

</html>